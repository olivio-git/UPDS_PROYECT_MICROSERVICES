# üìã Gu√≠a Completa de Testing - CBA Platform

## üöÄ **Configuraci√≥n Inicial**

### **1. Verificar Servicios**
```bash
# Verificar que todos los servicios est√©n corriendo
docker-compose ps

# Ver logs de servicios espec√≠ficos
docker-compose logs auth-service -f
docker-compose logs notifications-service -f
```

### **2. Health Checks**
```bash
# Auth Service
curl http://localhost:3000/health

# Notifications Service  
curl http://localhost:3001/health
```

---

## üîê **AUTH SERVICE - Testing Completo**

### **üìù 1. Registro de Usuario**

**POST** `http://localhost:3000/auth/register`

```json
{
  "email": "juan.perez@cba.com",
  "password": "MiPassword123",
  "firstName": "Juan",
  "lastName": "P√©rez",
  "role": "student"
}
```

**Respuesta Esperada:**
```json
{
  "success": true,
  "message": "Usuario registrado exitosamente",
  "data": {
    "user": {
      "_id": "...",
      "email": "juan.perez@cba.com",
      "firstName": "Juan",
      "lastName": "P√©rez",
      "role": "student",
      "isActive": true,
      "permissions": ["exam.take", "result.view"]
    },
    "accessToken": "eyJhbGciOiJIUzI1NiIs...",
    "refreshToken": "eyJhbGciOiJIUzI1NiIs...",
    "expiresIn": "1h"
  }
}
```

### **üîë 2. Login de Usuario**

**POST** `http://localhost:3000/auth/login`

```json
{
  "email": "juan.perez@cba.com",
  "password": "MiPassword123"
}
```

**Respuesta Esperada:**
```json
{
  "success": true,
  "message": "Inicio de sesi√≥n exitoso",
  "data": {
    "user": { /* datos del usuario */ },
    "accessToken": "eyJhbGciOiJIUzI1NiIs...",
    "refreshToken": "eyJhbGciOiJIUzI1NiIs...",
    "expiresIn": "1h"
  }
}
```

### **üîÑ 3. Refresh Token**

**POST** `http://localhost:3000/auth/refresh`

```json
{
  "refreshToken": "eyJhbGciOiJIUzI1NiIs..."
}
```

### **üë§ 4. Obtener Perfil (Requiere Token)**

**GET** `http://localhost:3000/auth/profile`

**Headers:**
```
Authorization: Bearer eyJhbGciOiJIUzI1NiIs...
```

### **üîì 5. Logout**

**POST** `http://localhost:3000/auth/logout`

**Headers:**
```
Authorization: Bearer eyJhbGciOiJIUzI1NiIs...
```

**Body:**
```json
{
  "refreshToken": "eyJhbGciOiJIUzI1NiIs..."
}
```

### **üîì 6. Logout All Sessions**

**POST** `http://localhost:3000/auth/logout-all`

**Headers:**
```
Authorization: Bearer eyJhbGciOiJIUzI1NiIs...
```

---

## üì± **OTP SERVICE - Testing Completo**

### **üì§ 1. Generar OTP**

**POST** `http://localhost:3000/auth/otp/generate`

```json
{
  "email": "juan.perez@cba.com",
  "purpose": "login"
}
```

**Prop√≥sitos disponibles:**
- `"login"` - Inicio de sesi√≥n
- `"password_reset"` - Restablecimiento de contrase√±a
- `"email_verification"` - Verificaci√≥n de email

**Respuesta Esperada:**
```json
{
  "success": true,
  "message": "C√≥digo OTP enviado exitosamente",
  "data": {
    "expiresIn": 600,
    "purpose": "login"
  }
}
```

### **‚úÖ 2. Verificar OTP**

**POST** `http://localhost:3000/auth/otp/verify`

```json
{
  "email": "juan.perez@cba.com",
  "code": "123456",
  "purpose": "login"
}
```

**Respuesta Esperada (Correcto):**
```json
{
  "success": true,
  "message": "C√≥digo OTP verificado exitosamente",
  "data": {
    "verified": true,
    "purpose": "login"
  }
}
```

**Respuesta (C√≥digo Incorrecto):**
```json
{
  "success": false,
  "message": "C√≥digo incorrecto. Intentos restantes: 2"
}
```

### **üìä 3. Estado del OTP**

**GET** `http://localhost:3000/auth/otp/status?email=juan.perez@cba.com&purpose=login`

**Respuesta Esperada:**
```json
{
  "success": true,
  "message": "Status de OTP obtenido",
  "data": {
    "exists": true,
    "expiresAt": "2025-07-21T18:15:00.000Z",
    "attemptsRemaining": 3
  }
}
```

### **üóëÔ∏è 4. Revocar OTP**

**DELETE** `http://localhost:3000/auth/otp/revoke`

```json
{
  "email": "juan.perez@cba.com",
  "purpose": "login"
}
```

---

## üìß **NOTIFICATIONS SERVICE - Testing**

### **üì§ 1. Enviar Email de Prueba**

**POST** `http://localhost:3001/notifications/send-test`

**Email de Bienvenida:**
```json
{
  "to": "juan.perez@cba.com",
  "type": "welcome",
  "data": {
    "firstName": "Juan",
    "lastName": "P√©rez"
  }
}
```

**Email OTP:**
```json
{
  "to": "juan.perez@cba.com",
  "type": "otp",
  "data": {
    "code": "123456",
    "purpose": "verificaci√≥n de cuenta",
    "expiryMinutes": 10
  }
}
```

**Email Reset Password:**
```json
{
  "to": "juan.perez@cba.com",
  "type": "password_reset",
  "data": {
    "resetToken": "abc123token",
    "firstName": "Juan"
  }
}
```

### **üìä 2. Estad√≠sticas de Emails**

**GET** `http://localhost:3001/notifications/stats`

**Respuesta Esperada:**
```json
{
  "success": true,
  "message": "Estad√≠sticas obtenidas exitosamente",
  "data": {
    "total": 15,
    "sent": 12,
    "pending": 2,
    "failed": 1,
    "today": 5,
    "successRate": "80.00",
    "recentFailures": [],
    "lastUpdated": "2025-07-21T17:30:00.000Z"
  }
}
```

### **üìú 3. Historial de Emails**

**GET** `http://localhost:3001/notifications/history?email=juan.perez@cba.com&limit=10`

### **üîÑ 4. Procesar Cola de Emails**

**POST** `http://localhost:3001/notifications/process-queue`

### **‚ôªÔ∏è 5. Reintentar Emails Fallidos**

**POST** `http://localhost:3001/notifications/retry-failed`

---

## üß™ **Flujos de Testing Completos**

### **üîÑ Flujo 1: Registro Completo con Email**

```bash
# 1. Registrar usuario
curl -X POST http://localhost:3000/auth/register \
  -H "Content-Type: application/json" \
  -d '{
    "email": "maria.rodriguez@cba.com",
    "password": "Password123",
    "firstName": "Mar√≠a",
    "lastName": "Rodr√≠guez",
    "role": "student"
  }'

# 2. Verificar que se envi√≥ email de bienvenida
curl http://localhost:3001/notifications/history?email=maria.rodriguez@cba.com

# 3. Login con el usuario
curl -X POST http://localhost:3000/auth/login \
  -H "Content-Type: application/json" \
  -d '{
    "email": "maria.rodriguez@cba.com",
    "password": "Password123"
  }'
```

### **üì± Flujo 2: Proceso OTP Completo**

```bash
# 1. Generar OTP
curl -X POST http://localhost:3000/auth/otp/generate \
  -H "Content-Type: application/json" \
  -d '{
    "email": "maria.rodriguez@cba.com",
    "purpose": "email_verification"
  }'

# 2. Verificar estado del OTP
curl "http://localhost:3000/auth/otp/status?email=maria.rodriguez@cba.com&purpose=email_verification"

# 3. Verificar OTP (usa el c√≥digo del email recibido)
curl -X POST http://localhost:3000/auth/otp/verify \
  -H "Content-Type: application/json" \
  -d '{
    "email": "maria.rodriguez@cba.com",
    "code": "123456",
    "purpose": "email_verification"
  }'
```

### **üîê Flujo 3: Autenticaci√≥n con Token**

```bash
# 1. Login y obtener token
RESPONSE=$(curl -s -X POST http://localhost:3000/auth/login \
  -H "Content-Type: application/json" \
  -d '{
    "email": "maria.rodriguez@cba.com",
    "password": "Password123"
  }')

# 2. Extraer token (manual desde la respuesta)
TOKEN="eyJhbGciOiJIUzI1NiIs..."

# 3. Acceder a perfil protegido
curl -X GET http://localhost:3000/auth/profile \
  -H "Authorization: Bearer $TOKEN"

# 4. Validar token
curl -X GET http://localhost:3000/auth/validate \
  -H "Authorization: Bearer $TOKEN"
```

---

## üö´ **Testing de Rate Limiting**

### **Probar L√≠mites de OTP**
```bash
# Generar m√∫ltiples OTP r√°pidamente para activar rate limiting
for i in {1..5}; do
  curl -X POST http://localhost:3000/auth/otp/generate \
    -H "Content-Type: application/json" \
    -d '{
      "email": "test.rate@cba.com",
      "purpose": "login"
    }'
  echo "Intento $i"
done
```

### **Probar L√≠mites de Login**
```bash
# M√∫ltiples intentos de login para activar rate limiting
for i in {1..12}; do
  curl -X POST http://localhost:3000/auth/login \
    -H "Content-Type: application/json" \
    -d '{
      "email": "test.rate@cba.com",
      "password": "wrongpassword"
    }'
  echo "Intento $i"
done
```

---

## üêû **Testing de Errores**

### **Casos de Error Esperados**

1. **Email duplicado en registro:**
```json
{
  "success": false,
  "message": "El usuario ya existe con este email"
}
```

2. **Credenciales incorrectas:**
```json
{
  "success": false,
  "message": "Credenciales inv√°lidas"
}
```

3. **Token expirado:**
```json
{
  "success": false,
  "message": "Token inv√°lido o expirado"
}
```

4. **OTP incorrecto:**
```json
{
  "success": false,
  "message": "C√≥digo incorrecto. Intentos restantes: 2"
}
```

5. **Rate limit excedido:**
```json
{
  "success": false,
  "message": "Demasiadas solicitudes"
}
```

---

## üìä **Monitoreo y Logs**

### **Ver Logs en Tiempo Real**
```bash
# Auth service logs
docker-compose logs auth-service -f

# Notifications service logs
docker-compose logs notifications-service -f

# Kafka logs (para eventos)
docker-compose logs kafka -f

# Todos los logs
docker-compose logs -f
```

### **Kafka UI (Debug Mode)**
```bash
# Iniciar con Kafka UI
docker-compose --profile debug up

# Acceder a: http://localhost:8080
# Ver topics: user-events, otp-events, email-events
```

---

## ‚úÖ **Checklist de Testing**

- [ ] ‚úÖ Auth service health check
- [ ] ‚úÖ Notifications service health check
- [ ] ‚úÖ Registro de usuario exitoso
- [ ] ‚úÖ Email de bienvenida recibido
- [ ] ‚úÖ Login exitoso con JWT
- [ ] ‚úÖ Acceso a endpoint protegido
- [ ] ‚úÖ Generaci√≥n de OTP
- [ ] ‚úÖ Email de OTP recibido
- [ ] ‚úÖ Verificaci√≥n de OTP exitosa
- [ ] ‚úÖ Rate limiting funcionando
- [ ] ‚úÖ Refresh token funcionando
- [ ] ‚úÖ Logout exitoso
- [ ] ‚úÖ Eventos Kafka public√°ndose
- [ ] ‚úÖ Estad√≠sticas de emails
- [ ] ‚úÖ Manejo de errores

**¬°Con esta gu√≠a puedes probar completamente todos los microservicios implementados!** üéâ